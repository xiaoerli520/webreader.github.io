<!DOCTYPE html>
<html ng-app="app">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimal-ui">
		<meta name="format-detection" content="telephone=no">
		<link rel="stylesheet" href="css/reset.css">
		<style type="text/css">
			html{
				width: 100%;
				height: 100%;
				overflow-x: hidden;

			}
			body{
				text-align: left;
				width:100%;
				overflow: hidden;
				background: #e9dfc7;/*背景的颜色，*/

			}
			.m-read-content{
				font-size:14px;
				color: #555;/*字体的颜色*/
				line-height:31px;
				padding:15px;

			}
			.m-read-content h4{
				font-size: 20px;
				color:#736357;
				border-bottom:solid 1px #736357;
				letter-spacing: 2px;
				margin: 0 0 1em 0;
			}
			.m-read-content p{
				text-indent: 2em;
				margin: 0.5em 0;
				letter-spacing: 0px;
				line-height:24px;

			}
			.u-tab{
				height: 34px;
				margin: 10px auto;
				line-height:34px;
				border-radius: 8px;
				border:1px solid #858382;
				font-size:12px;
				background: #000;
				opacity: 0.9;
			}
			.u-tab li{
				display: inline-block;
				width: 49%;
				border-right:1px solid #858382;
				text-align: center;
				color: #fff;
			}
			.u-tab li:nth-child(2){
				border-right: none;
			}
			.m-button-bar{
				width: 70%;
				max-width: 800px;
				padding: 5px;
				margin:0 auto;
			}
			.top-nav{
				position: fixed;
				top:0px;
				height: 50px;
				width: 100%;
				z-index: 9999;
				background: #000;
				opacity: 0.7;
			}
			.icon-back{
				position: absolute;
				top:14px;
				left: 10px;
				width: 23px;
				height: 23px;
				background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyNpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChNYWNpbnRvc2gpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkJGMkEyQkQxMjdBNDExRTU4NjA2QTJDMjFDQ0I0ODhEIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkJGMkEyQkQyMjdBNDExRTU4NjA2QTJDMjFDQ0I0ODhEIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6QkYyQTJCQ0YyN0E0MTFFNTg2MDZBMkMyMUNDQjQ4OEQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6QkYyQTJCRDAyN0E0MTFFNTg2MDZBMkMyMUNDQjQ4OEQiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4Ia560AAAHWklEQVR42uyd7W9U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);
				background-size: contain;
			}
			.nav-title{
				position: absolute;
				top: 16px;
				left: 42px;
				color:#d5d5d6;
			}
			.nav-title-three{
				position: relative;
				top: 16px;
				left: 42px;
				color:#d5d5d6;
			}
			.bottom-nav{
				position: fixed;
				bottom:0;
				height: 70px;
				width: 100%;
				z-index: 9998;
				background: #000;
				opacity: 0.75;
			}
			.bottom-button{

				float: left;
				height: 100%;
				width: 32.9%;
				border:1px solid white;
			}
			.nav-pannel-bk{
				position: fixed;
				bottom:70px;
				height: 135px;
				width: 100%;
				background: #000;
				opacity: 0.9;
				z-index: 10000;
			}
			.nav-pannel{
				position: fixed;
				bottom: 70px;
				height: 135px;
				width: 100%;
				background: none;
				color: #FFF;
				z-index: 10001;
			}
			.child-mod{
				padding:5px 10px;
				margin:15px;
			}
			.child-mod span{
				display: inline-block;
				padding-right: 20px;
				padding-left:10px;
			}
			.child-mod button:nth-child(2){
				margin-right: 20px;
			}
			.font-size-button{
				background: none;
				border:1px #8c8c8c solid;
				color:#fff;
				border-radius: 16px;
				padding:5px 40px;
			}
			.bk-container{
				position: relative;
				width: 30px;
				height: 30px;
				border-radius: 15px;
				background: #fff;
				display: inline-block;
				margin-right: 10px;
				vertical-align: -14px;
			}
			.bk-container-current{
				position: absolute;
				width: 32px;
				height: 32px;
				border-radius: 16px;
				border:1px #ff7800 solid;
				display: inline-block;
				top:-2px;
				left: -2px;
			}
			#bk-blue{
				background:#B3B3B3;
			}
			#bk-fadeyellow{
				background: #e9dfc7;
			}
			#bk-gray{
				background: gray;
			}
			.artical-action-mid{
				position: fixed;
				z-index: 10002;
				width: 100%;
				height: 40%;
				top:30%;
			}
			#font-shift{
				font-size: 16px;

			}
		</style>
	</head>
	<body>
		<div id="root" class="container">
			<div class="m-artical-action">
				<div class="artical-action-mid" id="action_mid"></div>
			</div>
			<div id="top-nav" class="top-nav" style="display:none;">
				<div class="icon-back"></div>
				<div class="nav-title">返回书架</div>
			</div>
			<div id="fiction_chapter_title"></div>
			<div id="fiction_container" class="m-read-content">

			</div>
			<div class="m-button-bar">
				<ul class="u-tab">
					<li id="prev_button">Prev</li>
					<li id="next_button">Next</li>
					<br/>
				</ul>
			</div>
			<div class="nav-pannel-bk font-container" style="display: none">
			</div>
			<div class="nav-pannel font-container" id="font-container" style="display: none">
				<div class="child-mod">
					<span>字号</span>
					<button id="large-font" class="font-size-button">大</button>
					<button id="small-font" class="font-size-button">小</button>
				</div>
				<div class="child-mod">
					<span>背景</span>
					<div class="bk-container" style="display: none">
						<div class="bk-container-current"></div>
					</div>
					<div class="bk-container" id="bk-white">
						<div class="bk-container-current"></div>
					</div>
					<div class="bk-container" id="bk-gray">
						<div class="bk-container-current"></div>
					</div>
					<div class="bk-container" id="bk-fadeyellow">
						<div class="bk-container-current"></div>
					</div>
					<div class="bk-container" id="bk-blue">
						<div class="bk-container-current"></div>
					</div>
				</div>
			</div>
			<div class="bottom-nav-bk bottom_nav" style="display:none"></div>
			<div id="bottom-nav bottom_nav" class="bottom-nav" style="display:none">
				<div class="bottom-button">
					<div class="icon-index"></div>
					<div class="nav-title-three">目录</div>
				</div>
				<div class="bottom-button" id="font-shift">
					<div class="icon-font"></div>
					<div class="nav-title-three">字体</div>
				</div>
				<div class="bottom-button" id="night-shift">
					<div class="icon-night"></div>
					<div class="nav-title-three">夜间模式</div>
				</div>
			</div>

		</div>
		<script src="lib/zepto.min.js"></script>
		<script>
			window.jQuery = $;
		</script>
		<script src="js/jquery.base64.js"></script>
		<script src="js/jquery.jsonp.js"></script>
		<script>
			(function(){
				var Util = (function(){
					var prefix = 'html5_reader_';
					var StorageGetter = function(key){
						return localStorage.getItem(prefix+key);
					}
					var StorageSetter = function(key,val){
						return localStorage.setItem(prefix+key,val);
					}
					var getBSONP = function (url,callback) {
						return $.jsonp({
							url : url,
							cache : true,
							callback : 'duokan_fiction_chapter',
							success : function (result) {
								var data = $.base64.decode(result);
								var json = decodeURIComponent(escape(data));
								callback(json);
							}
						})
					}
					//封装localstorage
					return {
						getBSONP : getBSONP,
						StorageGetter:StorageGetter,
						StorageSetter:StorageSetter
					}
				})();
				var Dom = {
					top_nav : $('#top-nav'),
					bottom_nav : $('.bottom-nav'),


				}
				var Win = $(window);
				var Doc = $(document);
				var RootContainer = $('#fiction_container');
				var initFontSize = Util.StorageGetter('font_size');
				var readerModel;
				var readerUI;
				initFontSize = parseInt(initFontSize);
				if(!initFontSize){
					initFontSize = 14;
				}
				RootContainer.css('font-size',initFontSize);

				var initBk = Util.StorageGetter('initBk');
				if(!initBk){
					initBk = '#e9dfc7';
				}
				$('body').css('background',initBk);
				var initFontcolor = Util.StorageGetter('initFontcolor');
				if(!initFontcolor){
					initFontcolor = '#555';
				}
				$('.m-read-content').css('color',initFontcolor);
				function main(){
					//整个项目的入口函数
					readerModel = ReaderModel();
					readerUI = ReaderBaseFrame(RootContainer);
					readerModel.init(function (data) {
						readerUI(data);
					});

					EventHandler();
				}
				function ReaderModel(){
					//实现和阅读器相关的数据交换方法
					var Chapter_id;
					var ChapterTotal;
					var init = function (UIcallback) {
						getFictionInfo(function () {
							getCurChapterContent(Chapter_id,function (data) {
								//todo 数据渲染
								UIcallback && UIcallback(data);
							});
						});
					}

					var getFictionInfo = function (callback) {
						$.get('data/chapter.json',function(data){
							//获得章节信息之后的回掉
							Chapter_id = Util.StorageGetter('chapter_id');
							if(Chapter_id==null){
								Chapter_id = data.chapters[1].chapter_id;
							}

							ChapterTotal = data.chapters.length;
							callback && callback();
						},'json');
					}
					var getCurChapterContent = function (chapter_id,callback) {
						$.get('data/data' + chapter_id + '.json' ,function (data) {
							//回掉
							if(data.result == 0){
								var url = data.jsonp;
								Util.getBSONP(url,function (data) {
									callback && callback(data);
								});
							}
						},'json')
					}
					var prevChapter = function(UIcallback){
						Chapter_id = parseInt(Chapter_id,10);
						if(Chapter_id == 0){
							return;
						}
						Chapter_id = Chapter_id-1;
						getCurChapterContent(Chapter_id,UIcallback);
						Util.StorageSetter('chapter_id',Chapter_id);
					}
					var nextChapter = function(UIcallback){
						Chapter_id = parseInt(Chapter_id,10);
						if(Chapter_id == ChapterTotal){
							return;
						}
						Chapter_id = Chapter_id+1;
						getCurChapterContent(Chapter_id,UIcallback);
						Util.StorageSetter('chapter_id',Chapter_id);
					}
					return {
						init : init,
						prevChapter : prevChapter,
						nextChapter : nextChapter
					}
				}
				function ReaderBaseFrame(container){
					//初始化界面
					function parseChapterData(jsonData){
						var jsonObj = JSON.parse(jsonData);
						var html = '<h4>' + jsonObj.t + '</h4>';
						for(var i = 1;i<jsonObj.p.length;i++){
							html += '<p>'+jsonObj.p[i] + '</p>';
						}
						return html;
					}
					return function(data){
						container.html(parseChapterData(data));
					}
				}
				function EventHandler(){
					//交互事件的绑定
					$('#action_mid').click(function(){
						if(Dom.top_nav.css('display') == 'none'){
							Dom.bottom_nav.show();
							Dom.top_nav.show();
						}else{
							Dom.bottom_nav.hide();
							Dom.top_nav.hide();
							$('.font-container').hide();
							$('#font-shift').css('font-size','16px');
						}
					});
					$('#font-shift').click(function () {
						if($('.font-container').css('display')=='none'){
							$('.font-container').show();
							$('#font-shift').css('font-size','22px');
						}else{
							$('.font-container').hide();
							$('#font-shift').css('font-size','16px');
						}
					});
					$('#bk-white').click(function () {
						$('body').css('background','#fff');//字体和颜色一起设置
						$('.m-read-content').css('color','black');
						Util.StorageSetter('initFontcolor','black');
						Util.StorageSetter('initBk','#fff');
					});
					$('#bk-gray').click(function () {
						$('body').css('background','gray');
						$('.m-read-content').css('color','black');
						Util.StorageSetter('initFontcolor','black');
						Util.StorageSetter('initBk','gray');
					});
					$('#bk-fadeyellow').click(function () {
						$('body').css('background','#e9dfc7');
						$('.m-read-content').css('color','#555');
						Util.StorageSetter('initFontcolor','#555');
						Util.StorageSetter('initBk','#e9dfc7');
					});
					$('#bk-blue').click(function () {
						$('body').css('background','#B3B3B3');
						$('.m-read-content').css('color','#555');
						Util.StorageSetter('initFontcolor','#555');
						Util.StorageSetter('initBk','#B3B3B3');
					});
					$('#night-shift').click(function () {
						$('body').css('background','#404040');
						$('.m-read-content').css('color','#ABABAB');
						Util.StorageSetter('initFontcolor','#ABABAB');
						Util.StorageSetter('initBk','#404040');
					})
					$('#large-font').click(function () {
						if(initFontSize>20){
							return;
						}
						initFontSize += 1;
						RootContainer.css('font-size',initFontSize);
						Util.StorageSetter('font_size',initFontSize);
					});
					$('#small-font').click(function () {
						if(initFontSize < 12){
							return;
						}
						initFontSize -= 1;
						RootContainer.css('font-size',initFontSize);
						Util.StorageSetter('font_size',initFontSize);
					});

					Win.scroll(function () {
						Dom.bottom_nav.hide();
						Dom.top_nav.hide();
						$('.font-container').hide();
						$('#font-shift').css('font-size','16px');
					});
					$('#prev_button').click(function () {
						//todo 获得张杰反野数据 然后数据渲染
						readerModel.prevChapter(function (data) {
							readerUI(data);
						});
					});
					$('#next_button').click(function () {
						readerModel.nextChapter(function(data){
							readerUI(data);
						});
					})

				}
				main();
			})();
		</script>
	</body>
</html>